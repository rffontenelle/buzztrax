name: Download translations

on:
  workflow_dispatch:
  push:
    paths:
     - .github/workflows/translations.yml
  #scheduled:
    # run daily at 00:00.
  #  - cron: '0 0 * * *'

env:
  I18N_BRANCH: translations

jobs:
  translations:
    runs-on: ubuntu-latest
    steps:
    - name: Retrieve source repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up git user as [bot]
      uses: fregante/setup-git-user@v2

    - name: Switch to a translation branch
      env:
        BRANCH: ${{env.I18N_BRANCH}}
      run: |
        if git fetch origin "+refs/heads/${BRANCH}:refs/remotes/origin/${BRANCH}"; then
          git checkout -B "${BRANCH}" "origin/${BRANCH}"
        else
          git checkout --track -b "origin/${BRANCH}"
        fi

    - name: Download translations from Translation Project
      run: |
        ./download-translations

    - name: Set up output for new and changed translation files
      id: pofiles
      run: |
        echo "new=$(git status -s po/*.po | grep '^??' | sed 's|^?? ||' | tr '\n' ' ')" >> $GITHUB_OUTPUT
        echo "changed=$(git status -s po/*.po | grep '^ M' | sed 's|^ M ||' | tr '\n' ' ')" >> $GITHUB_OUTPUT

    - name: Update LINGUAS with new languages, if any
      run: |
        if [ -n "${{ steps.pofiles.outputs.new }}" ]; then
          langs=$(echo "${{ steps.pofiles.outputs.new }}" | sed 's|po/||g;s|\.po||g')
          echo "Adding to po/LINGUAS: $langs"
          echo "$langs" >> po/LINGUAS
          (tr ' ' '\n' | sort -u) < po/LINGUAS > tmp 
          (tr '\n' ' ' | sed 's|^ ||;s| $||') < tmp > po/LINGUAS
          rm tmp
        else
          echo "No new translation files, po/LINGUAS not changed."
        fi

    - run: git status

    - name: Commit changes
      run: |
        git add po/*.po
        if ! git diff-index --cached --quiet HEAD $NEW; then
          git commit -m 'po: add new translations' $NEW po/LINGUAS
        fi
        if ! git diff-index --cached --quiet HEAD $CHANGED; then
          git commit -m 'po: add new translations' $CHANGED
        fi
      env:
        NEW: "${{ steps.pofiles.outputs.new }}"
        CHANGED: "${{ steps.pofiles.outputs.changed }}"
 
    - name: Create pull request
      uses: peter-evans/create-pull-request@v6
      with:
        title: Update translations from Translation Project
        delete-branch: true
        base: master
       
    
